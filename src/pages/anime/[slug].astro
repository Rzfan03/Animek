---
const { slug } = Astro.params;
import '../../styles/global.css'
import Navbar from '../../components/Navbar.astro';

let episodeData = null;
let animeData = null;
let epsList = [];
let error = null;

try {
    const episodeRes = await fetch(`https://www.sankavollerei.com/anime/zoronime/episode/${slug}`);
    episodeData = await episodeRes.json();
    
    console.log("Episode Data:", episodeData);
  
    const animeSlug = episodeData?.anime_slug;
    
    if (!animeSlug) {
        throw new Error("anime_slug tidak ditemukan dalam data episode");
    }
    
    const animeRes = await fetch(`https://www.sankavollerei.com/anime/zoronime/detail/${animeSlug}`);
    const animeResponse = await animeRes.json();
    
    console.log("Anime Response:", animeResponse);
    
  
    if (animeResponse && animeResponse.detail) {
        animeData = animeResponse.detail;
    } else if (animeResponse) {
  
        animeData = animeResponse;
    }
    
    epsList = animeData?.episode_list || [];
    
} catch (err) {
    error = err.message;
    console.error("Error fetching data:", err);
}
---
<body class="dark:bg-gray-950">

    {error && (
        <div class="p-5">
            <h1 class="text-red-500 text-2xl">Error: {error}</h1>
            <p>Slug Episode: {slug}</p>
            <p>Anime Slug: {episodeData?.anime_slug || 'Tidak ditemukan'}</p>
        </div>
    )}

    {(!episodeData || !animeData) ? (
        <div class="p-5">
            <h1 class="text-2xl text-white">Loading...</h1>
            {error && <p class="text-red-500">Error: {error}</p>}
        </div>
    ) : (
        <>
            <title>Nonton {episodeData.episode_title}</title>
            <Navbar/>

            <div class="flex flex-col lg:flex-row overflow-hidden">

                {/* LEFT SIDE */}
                <div class="flex flex-col p-5 lg:w-2/3 scrollbar-hide">
                    <iframe 
                        class="h-135 w-full" 
                        src={episodeData.streams?.[0]?.url} 
                        frameborder="0"
                        allowfullscreen
                        scrolling="no"
                    ></iframe>

                    <div class="flex flex-col">
                        <h1 class="text-indigo-500 mt-3 font-bold text-2xl">{episodeData.episode_title}</h1>
                        <p class="text-gray-400 text-sm">source : {episodeData.source}</p>
                        <p class="text-gray-300 mt-2 mb-2 text-balance">{animeData.synopsis || 'Tidak ada sinopsis'}</p>
                        <p class="text-white">Total Episode : {epsList.length}</p>
                    </div>

                    <div class="flex">
                        <a 
                            href="https://acefile.co/f/110709519/oploverz-plus-bnhs8-10-1080p003092fd-mkv" 
                            class="mt-3 bg-indigo-500 rounded-md text-white p-3"
                        >
                            Downloads 1080p
                        </a>
                    </div>
                </div>

                {/* RIGHT SIDE EPISODE LIST */}
                {epsList.length > 0 ? (
                    <div class="h-fit mt-5 mb-5 w-full lg:w-1/3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 max-md:grid-cols-1 gap-2">
                        {epsList.map((episode) => (
                            <div 
                                key={episode.id || episode.slug} 
                                class="border-2 border-gray-800 p-3 rounded-md flex gap-3 w-full items-center bg-gray-900"
                            >
                                
                                <div class="flex flex-col">
                                    <a 
                                        href={`/anime/${episode.slug}`} 
                                        class="text-blue-400 hover:underline text-center"
                                    >
                                       EPS {episode.name.substring(7)}
                                    </a>
                                    
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div class="p-5">
                        <p class="text-gray-400">Tidak ada episode tersedia</p>
                        <p class="text-sm text-gray-500">Anime Slug: {episodeData.anime_slug}</p>
                    </div>
                )}

            </div>
        </>
    )}

</body>
